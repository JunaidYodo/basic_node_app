generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== AUTHENTICATION & USERS ====================

model users {
  id             Int       @id @default(autoincrement())
  name           String
  email          String    @unique
  role_id        Int
  status         String
  gender         String?
  number         String?
  password       String    @db.Text
  remember_token String?   @db.Text
  deleted        Boolean   @default(false)
  created_by     Int?
  lat_long       String?
  postal_code    String?
  address        String?
  city           String?
  country        String?
  image          String?
  state          String?
  birth_date     DateTime? @db.Date
  last_login     DateTime  @default(now())
  created_at     DateTime  @default(now())
  updated_at     DateTime  @default(now())

  // Subscription fields
  stripe_customer_id     String?   @unique
  stripe_subscription_id String?   @unique
  subscription_status    String?   @default("free") // free, active, canceled, past_due
  subscription_plan      String?   @default("free") // free, standard, premium
  subscription_start     DateTime?
  subscription_end       DateTime?
  trial_ends_at          DateTime?

  // Feature limits
  applications_used    Int @default(0)
  applications_limit   Int @default(5) // Free: 5, Standard: 50, Premium: unlimited
  ai_generations_used  Int @default(0)
  ai_generations_limit Int @default(10) // Free: 10, Standard: 100, Premium: unlimited

  // Onboarding tracking
  onboarding_completed Boolean @default(false)
  onboarding_step      Int     @default(0) // 0: not started, 1: preferences, 2: resume upload, 3: profile review
  onboarding_data      Json? // Stores temporary onboarding data

  role             roles             @relation(fields: [role_id], references: [id])
  auth_log         auth_log[]
  notifications    notifications[]
  user_profiles    user_profiles?
  resumes          resumes[]
  jobs             jobs[]
  applications     applications[]
  subscriptions    subscriptions[]
  payment_history  payment_history[]
  user_preferences user_preferences?
  analytics        analytics[]

  @@index([email])
  @@index([stripe_customer_id])
}

model auth_log {
  id         Int           @id @default(autoincrement())
  user_id    Int
  type       auth_log_type @default(login)
  ip_address String?
  user_agent String?       @db.Text
  created_at DateTime      @default(now())
  users      users         @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
}

enum auth_log_type {
  login
  logout
  password_reset
  email_verified
}

model roles {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String?  @db.Text
  created_at  DateTime @default(now())
  updated_at  DateTime @default(now()) @updatedAt
  deleted     Boolean  @default(false)
  users       users[]
}

// ==================== USER PROFILE & RESUME ====================

model user_profiles {
  id                  Int      @id @default(autoincrement())
  user_id             Int      @unique
  headline            String?
  summary             String?  @db.Text
  skills              Json? // ["JavaScript", "React", ...]
  linkedin_url        String?
  github_url          String?
  portfolio_url       String?
  preferred_roles     Json? // ["Software Engineer", "Frontend Developer"]
  preferred_locations Json? // ["Remote", "New York", "San Francisco"]
  work_mode           String? // remote, hybrid, onsite
  salary_min          Int?
  salary_max          Int?
  currency            String?  @default("USD")
  completeness        Int      @default(0) // 0-100%
  created_at          DateTime @default(now())
  updated_at          DateTime @updatedAt

  user        users         @relation(fields: [user_id], references: [id], onDelete: Cascade)
  experiences experiences[]
  educations  educations[]

  @@index([user_id])
}

model experiences {
  id          Int       @id @default(autoincrement())
  profile_id  Int
  company     String
  title       String
  location    String?
  start_date  DateTime
  end_date    DateTime?
  is_current  Boolean   @default(false)
  description String    @db.Text
  created_at  DateTime  @default(now())
  updated_at  DateTime  @updatedAt

  profile user_profiles @relation(fields: [profile_id], references: [id], onDelete: Cascade)

  @@index([profile_id])
}

model educations {
  id          Int       @id @default(autoincrement())
  profile_id  Int
  institution String
  degree      String
  field       String?
  start_date  DateTime
  end_date    DateTime?
  is_current  Boolean   @default(false)
  description String?   @db.Text
  created_at  DateTime  @default(now())
  updated_at  DateTime  @updatedAt

  profile user_profiles @relation(fields: [profile_id], references: [id], onDelete: Cascade)

  @@index([profile_id])
}

model resumes {
  id          Int      @id @default(autoincrement())
  user_id     Int
  name        String
  file_path   String? // S3 or local path
  file_url    String? // Public URL
  parsed_data Json? // Full parsed JSON structure
  version     Int      @default(1)
  is_master   Boolean  @default(false)
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  user users @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([is_master])
}

// ==================== JOBS & APPLICATIONS ====================

model jobs {
  id             Int       @id @default(autoincrement())
  user_id        Int
  external_id    String? // Job ID from ATS
  source         String // greenhouse, workday, lever, linkedin, indeed, manual
  source_url     String?   @db.Text
  company_name   String
  job_title      String
  location       String?
  work_mode      String? // remote, hybrid, onsite
  salary_range   String?
  description    String    @db.Text
  requirements   Json?
  benefits       Json?
  posted_date    DateTime?
  deadline       DateTime?
  status         String    @default("active") // active, closed, draft
  ai_match_score Int? // 0-100
  created_at     DateTime  @default(now())
  updated_at     DateTime  @updatedAt

  user         users          @relation(fields: [user_id], references: [id], onDelete: Cascade)
  applications applications[]

  @@index([user_id])
  @@index([source])
  @@index([status])
}

model applications {
  id                   Int       @id @default(autoincrement())
  user_id              Int
  job_id               Int
  resume_version_id    Int?
  cover_letter         String?   @db.Text
  status               String    @default("draft") // draft, submitted, viewed, interview, offer, rejected
  submission_method    String? // api, automation, manual
  applied_at           DateTime?
  response_received_at DateTime?
  interview_date       DateTime?
  offer_date           DateTime?
  rejection_date       DateTime?
  notes                String?   @db.Text
  created_at           DateTime  @default(now())
  updated_at           DateTime  @updatedAt

  user               users                @relation(fields: [user_id], references: [id], onDelete: Cascade)
  job                jobs                 @relation(fields: [job_id], references: [id], onDelete: Cascade)
  application_events application_events[]

  @@index([user_id])
  @@index([job_id])
  @@index([status])
}

model application_events {
  id             Int      @id @default(autoincrement())
  application_id Int
  event_type     String // submitted, viewed, interview_scheduled, offer_received, rejected
  event_data     Json?
  created_at     DateTime @default(now())

  application applications @relation(fields: [application_id], references: [id], onDelete: Cascade)

  @@index([application_id])
}

// ==================== AI & PERSONALIZATION ====================

// AI logging has been removed - consider using analytics model for tracking

// ==================== STRIPE & SUBSCRIPTIONS ====================

model subscriptions {
  id                     Int       @id @default(autoincrement())
  user_id                Int
  stripe_subscription_id String    @unique
  stripe_customer_id     String
  stripe_price_id        String
  status                 String // active, canceled, past_due, trialing
  plan_name              String // free, standard, premium
  current_period_start   DateTime
  current_period_end     DateTime
  cancel_at_period_end   Boolean   @default(false)
  canceled_at            DateTime?
  trial_start            DateTime?
  trial_end              DateTime?
  created_at             DateTime  @default(now())
  updated_at             DateTime  @updatedAt

  user users @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([stripe_subscription_id])
}

model payment_history {
  id                Int      @id @default(autoincrement())
  user_id           Int
  stripe_payment_id String   @unique
  stripe_invoice_id String?
  amount            Float
  currency          String   @default("USD")
  status            String // succeeded, failed, pending
  payment_method    String? // card, bank_account
  description       String?
  receipt_url       String?
  created_at        DateTime @default(now())

  user users @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([stripe_payment_id])
}

// ==================== ANALYTICS & TRACKING ====================

model analytics {
  id           Int      @id @default(autoincrement())
  user_id      Int
  metric_type  String // application_submitted, interview_scheduled, offer_received, ai_generation
  metric_value Float
  metadata     Json?
  date         DateTime @default(now())

  user users @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([metric_type])
  @@index([date])
}

// ==================== USER PREFERENCES & SETTINGS ====================

model user_preferences {
  id                    Int      @id @default(autoincrement())
  user_id               Int      @unique
  email_notifications   Boolean  @default(true)
  application_reminders Boolean  @default(true)
  weekly_summary        Boolean  @default(true)
  theme                 String   @default("light") // light, dark
  timezone              String   @default("UTC")
  language              String   @default("en")
  created_at            DateTime @default(now())
  updated_at            DateTime @updatedAt

  user users @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
}

// ==================== NOTIFICATIONS ====================

model notifications {
  id         Int      @id @default(autoincrement())
  user_id    Int
  type       String // application_status, subscription, system
  title      String
  message    String   @db.Text
  is_read    Boolean  @default(false)
  link       String?
  metadata   Json?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  user users @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([is_read])
}
